
<div id="notification" class="alert alert-success alert-dismissible fade notification" role="alert">
  Anime ajouté à la watchlist !
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>


<div class="py-5" style="background:linear-gradient(rgba(0, 0, 0, .7), rgba(0, 0, 0, .7)), url('<%= @anime.image_urls.sample %>');
                        background-position: center;
                        background-size: cover;">

<div class="container text-white" style="padding:100px 0 100px 0;">
  <div class="row  align-items-end">
  <div class="col">
    <p class="fs-3">#<%= @anime.rank %> Most populair</p>
    <h1 class="display-1 fw-bold"><%= @anime.title %></h1>
    <p class="fs-6"> <%= truncate(@anime.synopsis, :length => 200) %></p>
    <p class="display-6">
      <% @avg.to_i.times do %>
     <i class="fa-solid fa-star"></i>
     <% end %>
     <% (5 - @avg.to_i).times do %>
     <i class="fa-regular fa-star"></i>
     <% end %> <span class="fs-6">(<%= @avg %>)</span> <br>
     </p>
    <a href="#" class="btn watchlist-button mt-5"> <i class="fa-solid fa-plus"></i> Add to watchlist</a>
    </div>
  <div class="col-4">
    <div class="bg-secondary p-3 rounded-3 d-inline-flex">
    <% @anime.image_urls.first(2).each do |image| %>
      <img src="<%= image %>" class="rounded-3 mx-2" alt="" width=250 >
    <% end %>
    </div>
  </div>
  </div>

  </div>
</div>

<div class="container mt-5">
  <div class="row justify-content-between">
    <div class="col-6">
      <h3 class="display-5 fw-bold mb-2">Details</h3>
      <p><%= @anime.synopsis %></p>
      <% unless @anime.producers.empty? %>
      <div class="characters">
        <div class="text-left">Publishers:</div> <div class="text-right"> <% @anime.producers.each do |prod| %> <%= prod %>,  <% end %> </div>
      </div>
      <hr>
      <% end %>
      <% unless @anime.themes.empty? %>
      <div class="characters">
        <div class="text-left">Themes:</div> <div class="text-right"> <% @anime.themes.each do |prod| %> <%= prod %>,  <% end %> </div>
      </div>
      <hr>
      <% end %>
      <% unless @anime.status.nil? %>
      <div class="characters">
        <div class="text-left">Status:</div> <div class="text-right"> <%= @anime.status %> </div>
      </div>
      <% end %>


    </div>
    <div class="col-6">
      <h3 class="display-5 fw-bold mb-2 pl-5">Trailer</h3>
      <iframe width="560" height="315" src="<%= @anime.embed_url %>" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
    </div>
  </div>

  <div class="row mt-3">
      <h3 class="display-5 fw-bold mb-2">Episodes</h3>
  <div class="row row-cols-1 row-cols-md-5 g-4">
    <% @anime.episodes.each do |episode| %>
    <div class="card-group">
      <div class="card">
        <img src="<%= episode.image %>" class="card-img-top" alt="...">
        <div class="card-body">
          <h5 class="card-title"><%= episode.title %></h5>
          <p class="card-text"><%= truncate(episode.description, :length => 100) %></p>
        </div>
      </div>

    </div>

    <% end %>

</div>
</div>

</div>
<div class="reviews-container container mt-5">
  <div class="reviews-header">
    <h3 class="display-5 fw-bold mb-2">Reviews</h3>
  </div>
  <div class="reviews-info">
    <p><%= @anime.reviews.count %> Reviews | <%= @avg %>
    <% @avg.to_i.times do %>
     <i class="fa-solid fa-star"></i>
     <% end %>
     <% (5 - @avg.to_i).times do %>
     <i class="fa-regular fa-star"></i>
     <% end %>
     </p>
  </div>
  <div class="account-required text-center py-3" style="background-color: #eaeaea;">
    <strong>Account Required</strong>
    <p><strong>Please</strong> Log in or Create an Account to <strong>add a review</strong></p>
  </div>
  <div class="reviews-list text-center mt-4 ">
    <% @anime.reviews.each do |review| %>
      <div class="review-container mb-4 d-inline-block">
        <div class="review">
          <div class="mb-3 d-flex justify-content-start review-info">
            <img src="" alt="User Photo" class="mr-2 rounded-circle" width="50" height="50">
            <div>
              <p class="mb-0 username"><%= review.user.username %></p>
              <p class="mb-0 rating">Rating: <%= review.rating %></p>
              <p class="mb-0 date"><%= review.created_at.strftime('%d %b %Y') %></p>
            </div>
          </div>
          <div data-controller="read-more" data-read-more-more-text-value="Read more" data-read-more-less-text-value="Read less">
            <p class="my-content" data-read-more-target="content">
              <%= review.content %>
            </p>
            <button data-action="read-more#toggle" style="border-radius: 20px;">Read more</button>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>

<style>
  .review-info {
    display: flex;
    align-items: center;
  }

  .user-photo,
  .username,
  .rating,
  .date {
    display: inline-block;
    margin-right: 10px;
  }
    .reviews-list {
    margin-left: 100px;
    margin-right: 100px;
  }
  .notification {
  position: fixed;
  top: 20px;
  right: 20px;
  height: 50px;
  background-color: #fff;
  color: #000;
  padding: 10px 20px;
  border-radius: 5px;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
  display: none;
}

.notification.show {
  display: block;
  animation: fadeOut 3s;
}

@keyframes fadeOut {
  0% {
    opacity: 1;
  }
  90% {
    opacity: 1;
  }
  100% {
    opacity: 0;
  }
}

</style>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
  $('.btn.watchlist-button').click(function(event) {
    // Effectuez ici les opérations d'ajout à la watchlist et affichage de la notification
    event.preventDefault();
    addToWatchlist();
  });
});

function addToWatchlist() {
  const animeId = <%= @anime.id%>

  const data = {
    anime_id: animeId,
    watchlist: {
      status: true
    },
    authenticity_token: $('meta[name="csrf-token"]').attr('content')
  };

  $.ajax({
    url: '/animes/<%= @anime.id %>/watchlists',
    type: 'POST',
    data: data,
    success: function(response) {
      showNotification('Anime added to your watchlist!');
    },
    error: function(xhr, status, error) {
      showNotification('Error adding anime to your watchlist.')
    }
  });
}

function showNotification() {
  const notification = $('#notification');
  notification.text("Anime sucessfully added to your Watchlist!");
  notification.addClass('show');

  setTimeout(function() {
    notification.fadeOut();
  }, 3000);
}
</script>


<!--<h2>Reviews</h2>

<h3>Episodes: </h3>
<% if @anime.episodes.present? %>
  <% @anime.episodes.each do |episode| %>
    <div>
      <p><strong>Episode: <%= episode.episodenumber %></strong></p>
      <p>Title: <%= episode.title %></p>
      <p>Release Date: <%= episode.date_aired.strftime("%a, %B %Y") %></p>
      <p>Summary: <%= episode.description %></p>
      <p>Duration: <%= episode.duration / 60 unless episode.duration.nil? %> minutes</p>


    </div>
  <% end %>
<% else %>
  <p>No episodes found.</p>
<% end %>

<h2>Reviews</h2>

<% if @anime.reviews.present? %>
  <% @anime.reviews.each do |review| %>
    <div>
      <p><strong>Rating: <%= review.rating %></strong></p>
      <p>Content: <%= review.content %></p>

      <% if current_user == review.user %>
        <%= link_to "Edit", edit_anime_review_path(@anime, review) %>
        <% #link_to "Delete", anime_review_path(@anime, review), method: :delete, data: { confirm: "Are you sure you want to delete this review?" } %>

      <% end %>
    </div>
  <% end %>
<% else %>
  <p>No reviews found.</p>
<% end %>
</div>
